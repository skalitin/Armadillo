@using Armadillo.Graph
@using Microsoft.JSInterop
@using System.Threading.Tasks
@using Armadillo.Shared
@using System.Linq
@using System.Collections.Generic
@inject IJSRuntime JsRuntime;

<div class="graph-container">
    <div id="network-wrapper"/>
    <div id="doughnut-wrapper"/>
</div>

@code {
    [Parameter]
    public Product Product { get; set; }
   
    [Parameter]
    public bool ShowCustomers { get; set; }
    
    [Parameter]
    public bool ShowOwners { get; set; }

    public async Task RenderNetworkAsync(Network network)
    {
        await JsRuntime.InvokeAsync<string>("RenderNetwork", network);
    } 

    public async Task RenderStatisticsAsync(IEnumerable<Slice> slices)
    {
        await JsRuntime.InvokeAsync<string>("RenderStatistics", slices);
    } 

    private string TruncateString(string value, int maxChars)
    {
        return value.Length <= maxChars ? value : value.Substring(0, maxChars) + "...";
    }

    private string GetTitle(Subcase subcase)
    {
        return
            $"<b>{subcase.Id}</b><br>" + 
            $"Level: {subcase.Level}<br>" + 
            $"Status: {subcase.Status}<br>" + 
            $"Customer: {subcase.Customer}<br>" + 
            $"Owner: {subcase.Owner}<br>" + 
            $"Created: {subcase.Created}<br>" + 
            $"Last update {subcase.LastUpdate}<br>" + 
            $"Refreshed at: {subcase.Loaded} UTC<br>" + 
            $"{subcase.Title}";
    }

    private NodeColor GetColor(Subcase subcase, int level)
    {
        // Source https://www.w3schools.com/colors/colors_trends.asp
        var colors = new Dictionary<int, string>
        {
            {1, "#9B2335"},
            {2, "#EFC050"},
            {3, "#5B5EA6"},
            {4, "#DFCFBE"},
        };

        var result = new NodeColor( colors[level] );
        if(subcase == null)
        {
            return result;
        }

        if(DateTime.UtcNow - subcase.Created > TimeSpan.FromDays(30))
        {
            result.Border = "#E15D44";
        }
        else if (subcase.Status == "Update from Support")
        {
            result.Border = "#98B4D4";
        }
        else if (subcase.Status == "Fix Provided")
        {
            result.Border = "#009B77";
        }

        return result;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if(Product == null)
        {
            await RenderNetworkAsync(new Network());
            return;
        }

        var subcases = Product.Subcases;
        var slices = new Dictionary<int, Slice>
        {
            {1, new Slice(1, 0, GetColor(null, 1).Background)},
            {2, new Slice(2, 0, GetColor(null, 2).Background)},
            {3, new Slice(3, 0, GetColor(null, 3).Background)},
            {4, new Slice(4, 0, GetColor(null, 4).Background)}
        };

        var nodes = new List<Node>();
        
        foreach(var each in subcases) 
        {
            var level = Int32.Parse(each.Level);
            var node =  new Node(each.Id, each.Id)
            {
                Title = GetTitle(each),
                Value = Math.Max(5, (int)((DateTime.UtcNow - each.Created).TotalDays) / 6)
            };

            node.Color = GetColor(each, level);    
            node.BorderWidth = String.IsNullOrEmpty(node.Color.Border) ? 0 : 5;
            nodes.Add(node);

            Slice slice = null;
            if(!slices.TryGetValue(level, out slice))
            {
                slice = new Slice(level, 0);
                slices.Add(level, slice);
            }
            slice.Count++;
        }
        
        var edges = new List<Edge>();
        if(ShowCustomers)
        {
            var customers = subcases.GroupBy(each => each.Customer,
                each => each, 
                (key, group) => new { Customer = key, Subcases = group});
            foreach (var item in customers)
            {
                nodes.Add(new Node(item.Customer, TruncateString(item.Customer, 15), "customers")
                {
                    Title = item.Customer
                });
                foreach (var subcase in item.Subcases)
                {
                    edges.Add(new Edge(item.Customer, subcase.Id));
                }
            }
        }

        if(ShowOwners)
        {
            var owners = subcases.GroupBy(each => each.Owner, 
                each => each, 
                (key, group) => new { Owner = key, Subcases = group});
            foreach (var item in owners)
            {
                nodes.Add(new Node(item.Owner, item.Owner, "owners")
                {
                    Title = item.Owner
                });
                foreach (var subcase in item.Subcases)
                {
                    edges.Add(new Edge(item.Owner, subcase.Id));
                }
            }
        }

        var network = new Network()
        {
            Nodes = nodes.ToArray(),
            Edges = edges.ToArray()
        };

        await RenderNetworkAsync(network);
        await RenderStatisticsAsync(slices.Values);
    }
}
